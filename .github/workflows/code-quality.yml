name: Code Quality & Coverage

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  quality-check:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript Type Check
        id: typecheck
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Run Linter
        id: lint
        run: npm run lint
        continue-on-error: true

      - name: Build Application
        id: build
        run: npm run build
        continue-on-error: true

      - name: Generate Coverage Report
        id: coverage
        run: |
          if [ -f "package.json" ] && grep -q "test:coverage" package.json; then
            npm run test:coverage || echo "No coverage script found"
          else
            echo "‚ö†Ô∏è No test:coverage script configured"
          fi
        continue-on-error: true

      - name: Calculate Code Statistics
        id: stats
        run: |
          echo "Calculating code statistics..."
          
          # Count TypeScript/JavaScript files
          TS_FILES=$(find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | grep -v node_modules | grep -v .next | grep -v dist | wc -l)
          
          # Count lines of code
          LOC=$(find . \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \) ! -path "*/node_modules/*" ! -path "*/.next/*" ! -path "*/dist/*" -exec cat {} \; | wc -l)
          
          echo "files=$TS_FILES" >> $GITHUB_OUTPUT
          echo "loc=$LOC" >> $GITHUB_OUTPUT

      - name: Comment PR with Quality Report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            
            const typecheckOutcome = '${{ steps.typecheck.outcome }}';
            const lintOutcome = '${{ steps.lint.outcome }}';
            const buildOutcome = '${{ steps.build.outcome }}';
            const coverageOutcome = '${{ steps.coverage.outcome }}';
            
            const files = '${{ steps.stats.outputs.files }}';
            const loc = '${{ steps.stats.outputs.loc }}';
            
            const getStatus = (outcome) => {
              if (outcome === 'success') return '‚úÖ Passed';
              if (outcome === 'failure') return '‚ùå Failed';
              if (outcome === 'skipped') return '‚è∏Ô∏è Skipped';
              return '‚ö†Ô∏è Warning';
            };
            
            const allPassed = typecheckOutcome === 'success' && 
                             lintOutcome === 'success' && 
                             buildOutcome === 'success';
            
            const comment = `## üìä Code Quality Report
            
            **Overall Status:** ${allPassed ? '‚úÖ All checks passed!' : '‚ö†Ô∏è Some checks need attention'}
            
            ### Quality Checks
            
            | Check | Status | Description |
            |-------|--------|-------------|
            | **TypeScript** | ${getStatus(typecheckOutcome)} | Type checking and compilation |
            | **Linter** | ${getStatus(lintOutcome)} | Code style and best practices |
            | **Build** | ${getStatus(buildOutcome)} | Production build verification |
            | **Coverage** | ${getStatus(coverageOutcome)} | Test coverage analysis |
            
            ### Code Statistics
            
            - üìÅ **Files:** ${files} TypeScript/JavaScript files
            - üìù **Lines of Code:** ${loc.toLocaleString()}
            
            ### Recommendations
            
            ${allPassed ? 
              '‚ú® Great work! All quality checks are passing.' : 
              '‚ö†Ô∏è Please review the failed checks above and address any issues.'}
            
            ---
            *Generated by Code Quality workflow*`;
            
            try {
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: owner,
                repo: repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not comment on PR:', error.message);
            }
